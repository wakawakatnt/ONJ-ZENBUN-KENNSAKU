<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>ONJ 掲示板データ検索</title>
<style>
  body { font-family: system-ui,-apple-system,Segoe UI,Roboto,'Hiragino Kaku Gothic ProN',Meiryo,Arial; margin: 18px; line-height: 1.5; background-color: #f4f4f9; color: #333; }
  input { padding: 10px; width: 70%; margin-right: 10px; border-radius: 6px; border: 1px solid #ccc; font-size: 1em; }
  button { padding: 10px 18px; border: none; border-radius: 6px; background-color: #1976d2; color: white; cursor: pointer; font-size: 1em; }
  button:hover { background-color: #1565c0; }
  #clearBtn { background-color: #757575; }
  #clearBtn:hover { background-color: #616161; }
  .controls { margin-bottom: 20px; display: flex; align-items: center; }
  .info { background: #e3f2fd; padding: 12px; margin-bottom: 20px; border-radius: 6px; border-left: 5px solid #1976d2; }

  /* スレッド検索結果のスタイル */
  .thread-result { border: 1px solid #ddd; border-radius: 8px; margin-bottom: 12px; background: #fff; box-shadow: 0 1px 3px rgba(0,0,0,0.05); }
  .thread-header { padding: 15px; cursor: pointer; display: flex; justify-content: space-between; align-items: center; transition: background-color 0.2s; }
  .thread-header:hover { background: #f5f5f5; }
  .thread-title { font-weight: bold; color: #1976d2; }
  .match-count { font-size: 0.9em; color: #666; background-color: #e0e0e0; padding: 3px 8px; border-radius: 12px; }
  .thread-details { display: none; padding: 0 15px 15px; border-top: 1px solid #eee; }
  .thread-meta { padding: 12px 0; font-size: 0.95em; }
  .thread-meta a { color: #007bff; text-decoration: none; }
  .thread-meta a:hover { text-decoration: underline; }
  
  /* レスのスタイル */
  .post { border-top: 1px dashed #ccc; padding: 12px 0; }
  .post:first-child { border-top: none; }
  .post-header { display: none; } /* Redundant with post-meta */
  .post-meta { font-size: 0.9em; color: #555; margin-bottom: 8px; }
  .post-meta strong { color: #008000; }
  .post-content { white-space: pre-wrap; line-height: 1.6; background: #fafafa; padding: 10px; border-radius: 4px;}
  .highlight { background-color: #ffeb3b; padding: 1px 2px; border-radius: 2px; }
</style>
</head>
<body>
<h2>ONJ 掲示板データ検索</h2>
<div class="controls">
  <input type="text" id="searchInput" placeholder="検索ワード（名前、ID、投稿内容）">
  <button id="searchBtn">検索</button>
  <button id="clearBtn">クリア</button>
</div>
<div id="info" class="info">ここにデータ情報や検索結果が表示されます。</div>
<div id="results"></div>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/12.2.1/firebase-app.js";
  import { getFirestore, collection, getDocs } from "https://www.gstatic.com/firebasejs/12.2.1/firebase-firestore.js";
  
  const firebaseConfig = {
    apiKey: "AIzaSyA2Z-JByRuaSv88nAj356nOh4CNgQb0_SY",
    authDomain: "onj-zenbun-kensaku.firebaseapp.com",
    projectId: "onj-zenbun-kensaku",
    storageBucket: "onj-zenbun-kensaku.firebasestorage.app",
    messagingSenderId: "171332002735",
    appId: "1:171332002735:web:c8dcad3ae133300900855a",
    measurementId: "G-DDHGB57HTW"
  };
  
  const app = initializeApp(firebaseConfig);
  const db = getFirestore(app);
  let allThreads = [];
  let originalDataInfo = {};

  function parseContentData(content) {
    const threads = [];
    // スレッドID (=!=!=) で全体を分割
    const threadBlocks = content.split('=!=!=');

    for (const block of threadBlocks) {
        const trimmedBlock = block.trim();
        if (!trimmedBlock) continue;
        
        const lines = trimmedBlock.split('\n');
        const threadId = lines.shift().trim(); // 最初の行がID
        if (!threadId) continue;

        const threadContent = lines.join('\n');
        
        // "名無しさん＠おーぷん<><>" を基準にレスを分割
        const postStrings = threadContent.split(/(?=名無しさん＠おーぷん<><>)/).filter(s => s.trim());
        if (postStrings.length === 0) continue;

        const posts = [];
        let threadTitle = "（タイトル不明）";

        // 各レス文字列を解析
        postStrings.forEach((postStr, index) => {
            const parts = postStr.split('<>');
            if (parts.length < 4) return;

            const author = parts[0];
            const postDetails = parts[2];
            let postContent = parts.slice(3).join('<>');

            // 最初のレスからタイトルを抽出
            if (index === 0) {
              const contentParts = postContent.split(/<br>|\n/);
              // 最後の意味のある行をタイトルとする
              threadTitle = contentParts.filter(p => p.trim()).pop() || threadTitle;
              // タイトル部分を本文から削除する場合
              // postContent = postContent.replace(new RegExp(threadTitle + '$'), '').trim();
            }
            
            const idMatch = postDetails.match(/(\d{2}\/\d{2}\/\d{2}\(.+?\) \d{2}:\d{2}:\d{2}) ID:(\S+)/);
            if (idMatch) {
                posts.push({
                    author: author.trim(),
                    postTime: idMatch[1],
                    userId: idMatch[2],
                    content: postContent.replace(/<br>/g, '\n').trim()
                });
            }
        });
        
        if (posts.length > 0) {
          threads.push({
            id: threadId,
            title: threadTitle,
            link: `https://hayabusa.open2ch.net/test/read.cgi/livejupiter/${threadId}/`,
            posts: posts,
            lastUpdated: posts[posts.length - 1].postTime
          });
        }
    }
    return threads;
  }
  
  async function fetchPosts() {
    try {
      document.getElementById('info').textContent = 'データを読み込み中...';
      
      const snapshot = await getDocs(collection(db, "aggregated_threads"));
      if (snapshot.docs.length === 0) {
        document.getElementById('info').textContent = 'データが見つかりません';
        return;
      }
      
      const doc = snapshot.docs[0];
      const data = doc.data();
      
      allThreads = parseContentData(data.content);
      
      const lastUpdated = data.lastUpdated ? new Date(data.lastUpdated.seconds * 1000).toLocaleString('ja-JP') : '不明';
      originalDataInfo = {
        threadCount: allThreads.length,
        postCount: allThreads.reduce((sum, t) => sum + t.posts.length, 0),
        lastUpdated: lastUpdated
      };

      updateInfoPanel();
      document.getElementById('results').innerHTML = '<p>検索ボックスにキーワードを入力して検索してください。</p>';
      
    } catch (err) {
      document.getElementById('info').textContent = `エラー: ${err.message}`;
      console.error(err);
    }
  }

  function updateInfoPanel(text = null) {
      if (text) {
          document.getElementById('info').innerHTML = text;
      } else {
          document.getElementById('info').innerHTML = `
            <strong>データ情報:</strong> スレッド数: ${originalDataInfo.threadCount}, 
            総投稿数: ${originalDataInfo.postCount}, 最終更新: ${originalDataInfo.lastUpdated}
          `;
      }
  }

  function highlightSearchTerm(text, term) {
    if (!term || !text) return text;
    // 特殊文字をエスケープ
    const escapedTerm = term.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
    const regex = new RegExp(`(${escapedTerm})`, 'gi');
    return text.replace(regex, '<span class="highlight">$1</span>');
  }

  function renderSearchResults(results, keyword) {
    const resultsDiv = document.getElementById('results');
    resultsDiv.innerHTML = '';

    if (results.length === 0) {
        resultsDiv.innerHTML = '<p>検索条件に一致するスレッドがありませんでした。</p>';
        return;
    }

    results.forEach(thread => {
        const threadDiv = document.createElement('div');
        threadDiv.className = 'thread-result';

        // ヘッダー（タイトルとヒット数）
        const headerDiv = document.createElement('div');
        headerDiv.className = 'thread-header';
        headerDiv.innerHTML = `
            <span class="thread-title">${highlightSearchTerm(thread.title, keyword)}</span>
            <span class="match-count">${thread.matchedPosts.length}件のレスがヒット</span>
        `;
        
        // 詳細部分（リンク、最終更新、ヒットしたレス）
        const detailsDiv = document.createElement('div');
        detailsDiv.className = 'thread-details';
        detailsDiv.innerHTML = `
            <div class="thread-meta">
                <a href="${thread.link}" target="_blank" rel="noopener noreferrer">このスレッドへのリンク</a> | <strong>最終更新:</strong> ${thread.lastUpdated}
            </div>
        `;

        thread.matchedPosts.forEach(post => {
            const postDiv = document.createElement('div');
            postDiv.className = 'post';
            
            const highlightedContent = highlightSearchTerm(post.content, keyword);
            const highlightedAuthor = highlightSearchTerm(post.author, keyword);
            const highlightedUserId = highlightSearchTerm(post.userId, keyword);
            
            postDiv.innerHTML = `
                <div class="post-meta">
                    <strong>${highlightedAuthor}</strong> | 
                    時刻: ${post.postTime} | 
                    ID: ${highlightedUserId}
                </div>
                <div class="post-content">${highlightedContent}</div>
            `;
            detailsDiv.appendChild(postDiv);
        });

        // クリックで詳細の表示/非表示を切り替え
        headerDiv.addEventListener('click', () => {
            const isHidden = detailsDiv.style.display === 'none' || detailsDiv.style.display === '';
            detailsDiv.style.display = isHidden ? 'block' : 'none';
        });

        threadDiv.appendChild(headerDiv);
        threadDiv.appendChild(detailsDiv);
        resultsDiv.appendChild(threadDiv);
    });
  }
  
  function searchPosts() {
    const keyword = document.getElementById('searchInput').value.trim();
    if (!keyword) {
      clearSearch();
      return;
    }

    const lowerKeyword = keyword.toLowerCase();
    const searchResults = [];

    allThreads.forEach(thread => {
        const matchedPosts = thread.posts.filter(post => {
            return (
                (post.author && post.author.toLowerCase().includes(lowerKeyword)) ||
                (post.userId && post.userId.toLowerCase().includes(lowerKeyword)) ||
                (post.content && post.content.toLowerCase().includes(lowerKeyword))
            );
        });

        if (matchedPosts.length > 0) {
            searchResults.push({
                ...thread,
                matchedPosts: matchedPosts
            });
        }
    });
    
    updateInfoPanel(`<strong>検索結果:</strong> "${keyword}" に一致するスレッド: ${searchResults.length}件`);
    renderSearchResults(searchResults, keyword);
  }
  
  function clearSearch() {
    document.getElementById('searchInput').value = '';
    document.getElementById('results').innerHTML = '<p>検索ボックスにキーワードを入力して検索してください。</p>';
    updateInfoPanel();
  }
  
  document.getElementById('searchBtn').addEventListener('click', searchPosts);
  document.getElementById('clearBtn').addEventListener('click', clearSearch);
  document.getElementById('searchInput').addEventListener('keypress', (e) => {
    if (e.key === 'Enter') {
      e.preventDefault(); // フォームの送信を防止
      searchPosts();
    }
  });
  
  // ページ読み込み時にデータ取得
  fetchPosts();
</script>
</body>
</html>
