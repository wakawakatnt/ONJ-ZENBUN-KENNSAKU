<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>ONJ 掲示板データ表示</title>
<style>
  body { font-family: system-ui,-apple-system,Segoe UI,Roboto,'Hiragino Kaku Gothic ProN',Meiryo,Arial; margin: 18px; line-height: 1.5; }
  input { padding: 8px; width: 70%; margin-right: 10px; }
  button { padding: 8px 15px; }
  .controls { margin-bottom: 20px; }
  .info { background: #e3f2fd; padding: 10px; margin-bottom: 15px; border-radius: 6px; }
  .post { border: 1px solid #ddd; border-radius: 8px; padding: 12px; margin: 8px 0; cursor: pointer; background: #fafafa; transition: background-color 0.2s; }
  .post:hover { background: #f0f0f0; }
  .post-header { font-weight: bold; color: #1976d2; margin-bottom: 4px; }
  .post-meta { font-size: 0.9em; color: #666; margin-bottom: 8px; }
  .post-content { white-space: pre-wrap; line-height: 1.4; }
  .highlight { background-color: #ffeb3b; padding: 1px 2px; }
</style>
</head>
<body>
<h2>ONJ 掲示板データ表示</h2>
<div class="controls">
  <input type="text" id="searchInput" placeholder="検索ワード（名前、ID、投稿内容）">
  <button id="searchBtn">検索</button>
  <button id="clearBtn">クリア</button>
</div>
<div id="info" class="info"></div>
<div id="results"></div>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/12.2.1/firebase-app.js";
  import { getFirestore, collection, getDocs } from "https://www.gstatic.com/firebasejs/12.2.1/firebase-firestore.js";
  
  const firebaseConfig = {
    apiKey: "AIzaSyA2Z-JByRuaSv88nAj356nOh4CNgQb0_SY",
    authDomain: "onj-zenbun-kensaku.firebaseapp.com",
    projectId: "onj-zenbun-kensaku",
    storageBucket: "onj-zenbun-kensaku.firebasestorage.app",
    messagingSenderId: "171332002735",
    appId: "1:171332002735:web:c8dcad3ae133300900855a",
    measurementId: "G-DDHGB57HTW"
  };
  
  const app = initializeApp(firebaseConfig);
  const db = getFirestore(app);
  let allPosts = [];
  let originalData = null;
  
  function parseContentData(content) {
    const posts = [];
    const lines = content.split('\n');
    let currentPost = null;
    
    for (let i = 0; i < lines.length; i++) {
      const line = lines[i];
      
      // タイムスタンプの行をチェック（=!=!=で始まる）
      if (line.startsWith('=!=!=')) {
        // 前のポストがあれば保存
        if (currentPost) {
          posts.push(currentPost);
        }
        // 新しいポストの開始
        currentPost = {
          timestamp: line.replace(/=!=!=/g, ''),
          content: ''
        };
      }
      // 日付の行をチェック（=?=?=で始まる）
      else if (line.startsWith('=?=?=')) {
        if (currentPost) {
          currentPost.dateTime = line.replace(/=\?=\?=/g, '');
        }
      }
      // 投稿内容の行
      else if (line.includes('名無しさん＠おーぷん') && line.includes('<>')) {
        const parts = line.split('<>');
        if (parts.length >= 4 && currentPost) {
          currentPost.author = parts[0];
          currentPost.postId = parts[2];
          currentPost.content = parts.slice(3).join('<>').trim();
          
          // 投稿IDから日時とIDを抽出
          const idMatch = currentPost.postId.match(/(\d{2}\/\d{2}\/\d{2}\(.+?\) \d{2}:\d{2}:\d{2}) ID:(\w+)/);
          if (idMatch) {
            currentPost.postTime = idMatch[1];
            currentPost.userId = idMatch[2];
          }
        }
      }
      // 継続するコンテンツ
      else if (currentPost && line.trim() && !line.startsWith('=')) {
        currentPost.content += '\n' + line;
      }
    }
    
    // 最後のポストを追加
    if (currentPost) {
      posts.push(currentPost);
    }
    
    return posts.filter(post => post.content && post.content.trim());
  }
  
  async function fetchPosts() {
    try {
      document.getElementById('info').textContent = 'データを読み込み中...';
      
      const snapshot = await getDocs(collection(db, "aggregated_threads"));
      
      if (snapshot.docs.length === 0) {
        document.getElementById('results').textContent = 'データが見つかりません';
        return;
      }
      
      const doc = snapshot.docs[0];
      const data = doc.data();
      originalData = data;
      
      // コンテンツをパースして投稿に分割
      allPosts = parseContentData(data.content);
      
      // 情報表示を更新
      const lastUpdated = data.lastUpdated ? new Date(data.lastUpdated.seconds * 1000).toLocaleString('ja-JP') : '不明';
      document.getElementById('info').innerHTML = `
        <strong>データ情報:</strong> スレッド数: ${data.threadCount}, 投稿数: ${allPosts.length}, 最終更新: ${lastUpdated}
      `;
      
      renderPosts(allPosts);
      
    } catch (err) {
      document.getElementById('results').textContent = `エラー: ${err.message}`;
      console.error(err);
    }
  }
  
  function renderPosts(posts) {
    const resultsDiv = document.getElementById('results');
    resultsDiv.innerHTML = '';
    
    if (posts.length === 0) {
      resultsDiv.textContent = '検索条件に一致する投稿がありません';
      return;
    }
    
    posts.slice(0, 50).forEach((post, index) => { // 最初の50件のみ表示
      const postDiv = document.createElement('div');
      postDiv.className = 'post';
      
      postDiv.innerHTML = `
        <div class="post-header">投稿 #${index + 1}</div>
        <div class="post-meta">
          <strong>${post.author || '名無し'}</strong> | 
          時刻: ${post.postTime || '不明'} | 
          ID: ${post.userId || '不明'}
        </div>
        <div class="post-content">${post.content || 'コンテンツなし'}</div>
      `;
      
      resultsDiv.appendChild(postDiv);
    });
    
    if (posts.length > 50) {
      const moreDiv = document.createElement('div');
      moreDiv.style.textAlign = 'center';
      moreDiv.style.padding = '15px';
      moreDiv.style.color = '#666';
      moreDiv.textContent = `... 他 ${posts.length - 50} 件の投稿があります`;
      resultsDiv.appendChild(moreDiv);
    }
  }
  
  function highlightSearchTerm(text, term) {
    if (!term) return text;
    const regex = new RegExp(`(${term})`, 'gi');
    return text.replace(regex, '<span class="highlight">$1</span>');
  }
  
  function searchPosts() {
    const keyword = document.getElementById('searchInput').value.toLowerCase().trim();
    if (!keyword) {
      renderPosts(allPosts);
      return;
    }
    
    const filtered = allPosts.filter(post => {
      return (
        (post.author && post.author.toLowerCase().includes(keyword)) ||
        (post.userId && post.userId.toLowerCase().includes(keyword)) ||
        (post.content && post.content.toLowerCase().includes(keyword)) ||
        (post.postTime && post.postTime.toLowerCase().includes(keyword))
      );
    });
    
    document.getElementById('info').innerHTML = `
      <strong>検索結果:</strong> "${keyword}" に一致する投稿: ${filtered.length}件
    `;
    
    renderPosts(filtered);
  }
  
  function clearSearch() {
    document.getElementById('searchInput').value = '';
    renderPosts(allPosts);
    if (originalData) {
      const lastUpdated = originalData.lastUpdated ? new Date(originalData.lastUpdated.seconds * 1000).toLocaleString('ja-JP') : '不明';
      document.getElementById('info').innerHTML = `
        <strong>データ情報:</strong> スレッド数: ${originalData.threadCount}, 投稿数: ${allPosts.length}, 最終更新: ${lastUpdated}
      `;
    }
  }
  
  document.getElementById('searchBtn').addEventListener('click', searchPosts);
  document.getElementById('clearBtn').addEventListener('click', clearSearch);
  document.getElementById('searchInput').addEventListener('keypress', (e) => {
    if (e.key === 'Enter') searchPosts();
  });
  
  // ページ読み込み時にデータ取得
  fetchPosts();
</script>
</body>
</html>
