<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>ONJ æ²ç¤ºæ¿éå»ãƒ­ã‚°æ¤œç´¢</title>
  <script async src="https://www.googletagmanager.com/gtag/js?id=G-DDHGB57HTW"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());
  gtag('config', 'G-DDHGB57HTW');
</script>
<style>
  body { font-family: system-ui,-apple-system,Segoe UI,Roboto,'Hiragino Kaku Gothic ProN',Meiryo,Arial; margin: 18px; line-height: 1.5; background-color: #f4f4f9; color: #333; }
  input[type="text"] { padding: 10px; width: 70%; margin-right: 10px; border-radius: 6px; border: 1px solid #ccc; font-size: 1em; }
  button { padding: 10px 18px; border: none; border-radius: 6px; background-color: #1976d2; color: white; cursor: pointer; font-size: 1em; }
  button:hover { background-color: #1565c0; }
  #clearBtn { background-color: #757575; }
  #clearBtn:hover { background-color: #616161; }
  #docsBtn { background-color: #4caf50; }
  #docsBtn:hover { background-color: #45a049; }
  #shareBtn { background-color: #ff9800; }
  #shareBtn:hover { background-color: #f57c00; }
  #refreshBtn { background-color: #f44336; }
  #refreshBtn:hover { background-color: #d32f2f; }
  #helpBtn { background-color: #9c27b0; }
  #helpBtn:hover { background-color: #7b1fa2; }
  .controls { margin-bottom: 20px; display: flex; align-items: center; gap: 10px; flex-wrap: wrap; }
  .info { background: #e3f2fd; padding: 12px; margin-bottom: 20px; border-radius: 6px; border-left: 5px solid #1976d2; }

  /* ãƒ•ã‚§ãƒƒãƒã‚ªãƒ—ã‚·ãƒ§ãƒ³ */
  .fetch-options { background: #fff; border: 1px solid #ddd; padding: 12px; border-radius: 6px; margin-bottom: 20px; display: flex; align-items: center; gap: 15px; flex-wrap: wrap; }
  .fetch-options label { display: inline-flex; align-items: center; gap: 5px; cursor: pointer; }
  .fetch-options input[type="number"] { width: 65px; padding: 6px; border-radius: 4px; border: 1px solid #ccc; }

  /* æ¤œç´¢ã‚ªãƒ—ã‚·ãƒ§ãƒ³ */
  .search-options-wrapper { display: flex; flex-direction: column; gap: 12px; margin-bottom: 20px; }
  .search-type-options, .sort-options, .search-mode-options { background: #fff; border: 1px solid #ddd; border-radius: 6px; padding: 12px; }
  .search-type-options label, .sort-options label, .search-mode-options label { margin-right: 20px; display: inline-flex; align-items: center; gap: 5px; cursor: pointer; }
  .search-type-options input[type="radio"], .sort-options input[type="radio"], .search-mode-options input[type="radio"] { margin-right: 5px; }
  .sort-options { display: none; } /* åˆæœŸçŠ¶æ…‹ã¯éè¡¨ç¤º */

  /* ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆä¸€è¦§ã®ã‚¹ã‚¿ã‚¤ãƒ« */
  .documents-list { background: #fff; border: 1px solid #ddd; border-radius: 8px; margin-bottom: 20px; display: none; }
  .documents-header { padding: 15px; background: #f5f5f5; border-bottom: 1px solid #ddd; font-weight: bold; display: flex; justify-content: space-between; align-items: center; }
  .document-item { padding: 12px 15px; border-bottom: 1px solid #eee; display: flex; justify-content: space-between; align-items: center; cursor: pointer; transition: background-color 0.2s; }
  .document-item:hover { background: #f9f9f9; }
  .document-item:last-child { border-bottom: none; }
  .document-name { font-weight: 500; color: #1976d2; }
  .document-info { display: flex; gap: 15px; font-size: 0.9em; color: #666; }
  .document-size { font-weight: bold; }
  .document-stats { font-size: 0.8em; }
  .active-document { background: #e8f5e8; }

  /* ã‚¹ãƒ¬ãƒƒãƒ‰æ¤œç´¢çµæœã®ã‚¹ã‚¿ã‚¤ãƒ« */
  .thread-result { border: 1px solid #ddd; border-radius: 8px; margin-bottom: 12px; background: #fff; box-shadow: 0 1px 3px rgba(0,0,0,0.05); }
  .thread-header { padding: 15px; cursor: pointer; display: flex; justify-content: space-between; align-items: center; transition: background-color 0.2s; gap: 15px; }
  .thread-header:hover { background: #f5f5f5; }
  .thread-title-wrapper { flex-grow: 1; min-width: 0; }
  .thread-title { font-weight: bold; color: #1976d2; display: block; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
  .thread-stats { text-align: right; flex-shrink: 0; }
  .total-posts { font-size: 0.85em; color: #666; display: block; }
  .match-count { font-size: 0.9em; color: #c0392b; font-weight: bold; }
  .document-source { font-size: 0.8em; color: #888; font-style: italic; }
  .last-updated { font-size: 0.8em; color: #666; margin-top: 2px; }
  
  .thread-details { display: none; padding: 0 15px 15px; border-top: 1px solid #eee; }
  .thread-meta { padding: 12px 0; font-size: 0.95em; display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 10px; }
  .thread-meta a { color: #007bff; text-decoration: none; }
  .thread-meta a:hover { text-decoration: underline; }
  
  /* ãƒ¬ã‚¹å–å¾—ãƒœã‚¿ãƒ³ */
  .post-control-buttons { display: flex; gap: 10px; flex-wrap: wrap; }
  .post-control-buttons button { padding: 6px 12px; font-size: 0.85em; background-color: #28a745; }
  .post-control-buttons button:hover { background-color: #218838; }
  .post-control-buttons button.active { background-color: #ffc107; color: #212529; }
  .post-control-buttons button.active:hover { background-color: #e0a800; }
  
  /* å€‹åˆ¥ãƒ¬ã‚¹ã®ãƒœã‚¿ãƒ³ */
  .post-buttons { display: inline-flex; gap: 5px; margin-left: 10px; }
  .post-buttons button { padding: 3px 8px; font-size: 0.75em; background-color: #6c757d; }
  .post-buttons button:hover { background-color: #5a6268; }
  .post-buttons button:disabled { background-color: #aaa; cursor: not-allowed; opacity: 0.6; }
  .post-buttons .copy-btn { background-color: #17a2b8; }
  .post-buttons .copy-btn:hover { background-color: #138496; }
  
  /* ãƒ¬ã‚¹ã®ã‚¹ã‚¿ã‚¤ãƒ« */
  .post { border-top: 1px dashed #ccc; padding: 12px 0; position: relative; }
  .post:first-child { border-top: none; }
  .post-meta { font-size: 0.9em; color: #555; margin-bottom: 8px; }
  .post-meta strong { color: #008000; cursor: pointer; }
  .post-meta strong:hover { text-decoration: underline; }
  .post-content { white-space: pre-wrap; line-height: 1.6; background: #fafafa; padding: 10px; border-radius: 4px; word-wrap: break-word; }
  .highlight { background-color: #ffeb3b; padding: 1px 2px; border-radius: 2px; }
  
  /* å®‰ä¾¡ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ */
  .anchor-link { color: #1976d2; text-decoration: underline; cursor: pointer; }
  .anchor-preview { position: absolute; background: #fff; border: 2px solid #1976d2; border-radius: 6px; padding: 10px; max-width: 400px; z-index: 1000; box-shadow: 0 4px 12px rgba(0,0,0,0.15); font-size: 0.9em; }
  .anchor-preview .preview-meta { font-weight: bold; color: #008000; margin-bottom: 5px; }
  .anchor-preview .preview-content { white-space: pre-wrap; line-height: 1.4; }

  /* ãƒ¡ãƒ‡ã‚£ã‚¢åŸ‹ã‚è¾¼ã¿ */
  .media-embed { margin: 10px 0; border: 1px solid #ddd; border-radius: 6px; overflow: hidden; }
  .media-embed img { max-width: 100%; height: auto; display: block; }
  .media-embed iframe { width: 100%; height: 400px; border: none; }
  .media-embed-x iframe { height: 500px; }

  /* æ¤œç´¢çµæœã‚µãƒãƒªãƒ¼ */
  .search-summary { background: #fff3cd; border: 1px solid #ffeaa7; padding: 12px; border-radius: 6px; margin-bottom: 20px; }
  .search-summary strong { color: #856404; }

  /* ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°è¡¨ç¤º */
  .loading { text-align: center; padding: 40px; color: #666; }
  .loading::after { content: ''; display: inline-block; width: 20px; height: 20px; border: 2px solid #ddd; border-radius: 50%; border-top-color: #1976d2; animation: spin 1s ease-in-out infinite; margin-left: 10px; }
  @keyframes spin { to { transform: rotate(360deg); } }

  /* èª¬æ˜ãƒ‘ãƒãƒ« */
  .help-panel { background: #fff; border: 1px solid #ddd; border-radius: 8px; margin-bottom: 20px; padding: 20px; display: none; }
  .help-panel h3 { color: #1976d2; margin-top: 0; }
  .help-panel h4 { color: #333; margin-top: 20px; margin-bottom: 10px; }
  .help-panel ul { margin-left: 20px; }
  .help-panel li { margin-bottom: 5px; }

  /* ãƒ¬ã‚¹ãƒãƒ³ã‚·ãƒ–å¯¾å¿œ */
  @media (max-width: 768px) {
    .controls { flex-direction: column; align-items: stretch; }
    input[type="text"] { width: 100%; margin-right: 0; margin-bottom: 10px; box-sizing: border-box; }
    .document-item { flex-direction: column; align-items: flex-start; gap: 8px; }
    .document-info { flex-direction: column; gap: 5px; }
    .search-type-options label, .sort-options label, .search-mode-options label { display: block; margin-bottom: 8px; }
  }
</style>
</head>
<body>
<h2>ONJ æ²ç¤ºæ¿éå»ãƒ­ã‚°æ¤œç´¢ã‚·ã‚¹ãƒ†ãƒ </h2>

<div class="controls">
  <input type="text" id="searchInput" placeholder="æ¤œç´¢ãƒ¯ãƒ¼ãƒ‰ï¼ˆåå‰ã€IDã€æŠ•ç¨¿å†…å®¹ï¼‰">
  <button id="searchBtn">æ¤œç´¢</button>
  <button id="clearBtn">ã‚¯ãƒªã‚¢</button>
  <button id="docsBtn">ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆä¸€è¦§</button>
  <button id="shareBtn">URLå…±æœ‰</button>
  <button id="helpBtn">èª¬æ˜(é€Ÿå ±ã€€æ¤œç´¢æ©Ÿèƒ½ãŒå¾©æ´»ã—ã¾ã—ãŸ)</button>
</div>

<div class="fetch-options">
  <strong>æ¤œç´¢å¯¾è±¡:</strong>
  <label>
    æœ€æ–° <input type="number" id="fetchCount" value="15" min="1"> ä»¶
  </label>
  <label>
    <input type="checkbox" id="fetchAllDocs"> å…¨ã¦å–å¾—
  </label>
  <button id="refreshBtn" title="ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚’ã‚¯ãƒªã‚¢ã—ã¦å†å–å¾—ãƒ»å†æ¤œç´¢ã—ã¾ã™">ãƒªãƒ•ãƒ¬ãƒƒã‚·ãƒ¥</button>
</div>

<div class="search-options-wrapper">
  <div id="searchModeOptions" class="search-mode-options">
    <strong>æ¤œç´¢ãƒ¢ãƒ¼ãƒ‰:</strong>
    <label>
      <input type="radio" name="searchMode" value="default" checked> é€šå¸¸æ¤œç´¢
    </label>
    <label>
      <input type="radio" name="searchMode" value="and"> ANDæ¤œç´¢
    </label>
    <label>
      <input type="radio" name="searchMode" value="or"> ORæ¤œç´¢
    </label>
  </div>

  <div id="searchTypeOptions" class="search-type-options">
    <strong>æ¤œç´¢ç¯„å›²:</strong>
    <label>
      <input type="radio" name="searchType" value="all" checked> å…¨ã¦
    </label>
    <label>
      <input type="radio" name="searchType" value="title"> ã‚¹ãƒ¬ã‚¿ã‚¤ã®ã¿
    </label>
    <label>
      <input type="radio" name="searchType" value="body"> æœ¬æ–‡ã®ã¿ (åå‰, ID, æŠ•ç¨¿å†…å®¹)
    </label>
  </div>

  <div id="sortOptions" class="sort-options">
    <strong>çµæœã®ä¸¦ã³é †:</strong>
    <label>
      <input type="radio" name="sortOrder" value="newest" checked> æœ€æ–°é †
    </label>
    <label>
      <input type="radio" name="sortOrder" value="oldest"> å¤ã„é †
    </label>
    <label>
      <input type="radio" name="sortOrder" value="document"> ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆåé †
    </label>
    <label>
      <input type="radio" name="sortOrder" value="relevance"> é–¢é€£åº¦é †
    </label>
  </div>
</div>

<div id="helpPanel" class="help-panel">
  <h3>ONJæ²ç¤ºæ¿ãƒ‡ãƒ¼ã‚¿æ¤œç´¢ã‚·ã‚¹ãƒ†ãƒ  - ä½¿ã„æ–¹ã‚¬ã‚¤ãƒ‰</h3>
  
  <h4>æ¦‚è¦</h4>
  <p>ã“ã®ã‚·ã‚¹ãƒ†ãƒ ã¯ãŠã‚“Jã®ã‚¹ãƒ¬ãƒƒãƒ‰ãƒ‡ãƒ¼ã‚¿ã‚’æ¤œç´¢ãƒ»é–²è¦§ã§ãã‚‹ãƒ„ãƒ¼ãƒ«ã§ã™ã€‚ã‚¹ãƒ¬ãƒƒãƒ‰ã‚¿ã‚¤ãƒˆãƒ«ã€æŠ•ç¨¿è€…åã€IDã€æŠ•ç¨¿å†…å®¹ã‚’å¯¾è±¡ã«æ¤œç´¢ã§ãã¾ã™ã€‚</p>
  <h4>ç·Šæ€¥</h4>
  <ul>
    <li><strong>æ¤œç´¢æ©Ÿèƒ½ãŒå¾©æ´»ã—ã¾ã—ãŸã€€ãã‚Œã«ä¼´ã„ãƒ‡ãƒ¼ã‚¿åé›†ã‚’åœæ­¢ã—ã¾ã™ã€€ã‚ã‚ŠãŒã¨ã†ã”ã–ã„ã¾ã—ãŸğŸ¥ºã€€ä»Šå¾Œã¯ãŠã‚“Jã®æ¤œç´¢ãŒæ­¢ã¾ã£ã¦ã„ãŸé–“(9æœˆ12æ—¥ã‹ã‚‰9æœˆ30æ—¥12æ™‚ãã‚‰ã„)ã®æƒ…å ±ã‚’æ¤œç´¢ã§ãã‚‹ã‚µãƒ¼ãƒ“ã‚¹ã¨ãªã‚Šã¾ã™</strong>
  </ul>
  <h4>åŸºæœ¬çš„ãªä½¿ã„æ–¹</h4>
  <ul>
    <li><strong>æ¤œç´¢:</strong> æ¤œç´¢ãƒœãƒƒã‚¯ã‚¹ã«ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã‚’å…¥åŠ›ã—ã¦ã€Œæ¤œç´¢ã€ãƒœã‚¿ãƒ³ã‚’æŠ¼ã™ã‹ã€Enterã‚­ãƒ¼ã‚’æŠ¼ã—ã¦ãã ã•ã„</li>
    <li><strong>IDæ¤œç´¢:</strong> ã€Œid:â—‹â—‹â—‹â—‹ã€ã®å½¢å¼ã§å…¥åŠ›ã™ã‚‹ã¨ã€ç‰¹å®šã®IDã§æŠ•ç¨¿ã•ã‚ŒãŸãƒ¬ã‚¹ã‚’æ¤œç´¢ã§ãã¾ã™</li>
    <li><strong>æ¤œç´¢ç¯„å›²:</strong> ã€Œå…¨ã¦ã€ã€Œã‚¹ãƒ¬ã‚¿ã‚¤ã®ã¿ã€ã€Œæœ¬æ–‡ã®ã¿ã€ã‹ã‚‰é¸æŠã§ãã¾ã™</li>
    <li><strong>ä¸¦ã³é †:</strong> ã€Œæœ€æ–°é †ã€ã€Œå¤ã„é †ã€ã€Œãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆåé †ã€ã€Œé–¢é€£åº¦é †ã€ã‹ã‚‰é¸æŠã§ãã¾ã™</li>
  </ul>

  <h4>æ¤œç´¢ãƒ¢ãƒ¼ãƒ‰</h4>
  <ul>
    <li><strong>é€šå¸¸æ¤œç´¢:</strong> å…¥åŠ›ã—ãŸã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ãŒå«ã¾ã‚Œã¦ã„ã‚‹ã‹ã‚’ãƒã‚§ãƒƒã‚¯</li>
    <li><strong>ANDæ¤œç´¢:</strong> å…¨ã¦ã®ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ãŒå«ã¾ã‚Œã¦ã„ã‚‹ã‚‚ã®ã‚’æ¤œç´¢ï¼ˆã‚¹ãƒšãƒ¼ã‚¹åŒºåˆ‡ã‚Šï¼‰</li>
    <li><strong>ORæ¤œç´¢:</strong> ã„ãšã‚Œã‹ã®ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ãŒå«ã¾ã‚Œã¦ã„ã‚‹ã‚‚ã®ã‚’æ¤œç´¢ï¼ˆã‚¹ãƒšãƒ¼ã‚¹åŒºåˆ‡ã‚Šï¼‰</li>
  </ul>
  
  <h4>æ¤œç´¢å¯¾è±¡ã®è¨­å®š</h4>
  <ul>
    <li><strong>æœ€æ–°â—‹ä»¶:</strong> æœ€æ–°ã®ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã‹ã‚‰æŒ‡å®šã—ãŸä»¶æ•°ã‚’æ¤œç´¢å¯¾è±¡ã«ã—ã¾ã™</li>
    <li><strong>å…¨ã¦å–å¾—:</strong> ãƒã‚§ãƒƒã‚¯ã™ã‚‹ã¨ã€åˆ©ç”¨å¯èƒ½ãªå…¨ã¦ã®ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã‚’æ¤œç´¢å¯¾è±¡ã«ã—ã¾ã™</li>
    <li><strong>ãƒªãƒ•ãƒ¬ãƒƒã‚·ãƒ¥:</strong> ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚’ã‚¯ãƒªã‚¢ã—ã¦æœ€æ–°ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—ã—ç›´ã—ã¾ã™</li>
  </ul>
  
  <h4>æ¤œç´¢çµæœã®æ“ä½œ</h4>
  <ul>
    <li><strong>ã‚¹ãƒ¬ãƒƒãƒ‰å±•é–‹:</strong> ã‚¹ãƒ¬ãƒƒãƒ‰ã‚¿ã‚¤ãƒˆãƒ«ã‚’ã‚¯ãƒªãƒƒã‚¯ã™ã‚‹ã¨ã€ãƒãƒƒãƒã—ãŸæŠ•ç¨¿ãŒè¡¨ç¤ºã•ã‚Œã¾ã™</li>
    <li><strong>å…¨ãƒ¬ã‚¹è¡¨ç¤º:</strong> ã€Œå…¨ãƒ¬ã‚¹è¡¨ç¤ºã€ãƒœã‚¿ãƒ³ã§ã‚¹ãƒ¬ãƒƒãƒ‰å†…ã®å…¨ã¦ã®æŠ•ç¨¿ã‚’è¡¨ç¤ºã§ãã¾ã™</li>
    <li><strong>ä¸Š100ãƒ¬ã‚¹/ä¸‹100ãƒ¬ã‚¹:</strong> å„æŠ•ç¨¿ã®å‰å¾Œ100ãƒ¬ã‚¹ã‚’è¡¨ç¤ºã§ãã¾ã™ï¼ˆä¸Šã¯-100ã€œ-1ã€ä¸‹ã¯+1ã€œ+100ï¼‰</li>
    <li><strong>ãƒ¬ã‚¹ç•ªå·ã‚¯ãƒªãƒƒã‚¯:</strong> ãƒ¬ã‚¹ç•ªå·ã‚’ã‚¯ãƒªãƒƒã‚¯ã™ã‚‹ã¨ã€å…ƒã‚¹ãƒ¬ãƒƒãƒ‰ã®è©²å½“ãƒ¬ã‚¹ã¸ã‚¸ãƒ£ãƒ³ãƒ—ã—ã¾ã™</li>
  </ul>
  
  <h4>ãã®ä»–ã®æ©Ÿèƒ½</h4>
  <ul>
    <li><strong>URLå…±æœ‰:</strong> æ¤œç´¢çµæœã®URLã‚’ã‚³ãƒ”ãƒ¼ã—ã¦ä»–ã®äººã¨å…±æœ‰ã§ãã¾ã™</li>
    <li><strong>ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆä¸€è¦§:</strong> åˆ©ç”¨å¯èƒ½ãªãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã®è©³ç´°æƒ…å ±ã‚’ç¢ºèªã§ãã¾ã™</li>
    <li><strong>ã‚¹ãƒ¬ãƒƒãƒ‰ãƒªãƒ³ã‚¯:</strong> å…ƒã®æ²ç¤ºæ¿ã‚¹ãƒ¬ãƒƒãƒ‰ã¸ã®ãƒªãƒ³ã‚¯ã‚‚è¡¨ç¤ºã•ã‚Œã¾ã™</li>
  </ul>

  <h4>æ³¨æ„</h4>
  <ul>
    <li><strong>æœŸé–“:</strong> æ®‹å¿µãªãŒã‚‰9æœˆ12æ—¥ä»¥é™ã®ãƒ‡ãƒ¼ã‚¿ã—ã‹ã‚ã‚Šã¾ã›ã‚“</li>
    <li><strong>é›†è¨ˆã§ãã‚‹ã‚¹ãƒ¬ãƒƒãƒ‰:</strong> å¼·åˆ¶sageã®ã‚¹ãƒ¬ãƒƒãƒ‰ã¯é›†è¨ˆã§ãã¾ã›ã‚“</li>
    <li><strong>è³ªå•ãªã©ãŒã‚ã£ãŸã‚‰:</strong>
      <a href="https://hayabusa.open2ch.net/test/read.cgi/livejupiter/1758380830/" target="_blank">ã“ã¡ã‚‰</a>
    </li>
 </ul>
  <h4>ãã®ä»–ä¾¿åˆ©ã‚µã‚¤ãƒˆ</h4>
  <ul>
    <li><strong>ãŠã‚“Jã®è£æŠ€ã«é–¢ã™ã‚‹wiki:</strong><a href="https://w.atwiki.jp/opensecretj/" target="_blank">Jazap!</a></li>
    <li><strong>IDæ¤œç´¢ãƒ–ãƒƒã‚¯ãƒãƒ¼ã‚¯ãƒ¬ãƒƒãƒˆ(ãŠã‚“Jæ°‘ã‹ã‚‰æä¾›):</strong><a href="https://pastebin.com/vt1Xctzp" target="_blank">IDæ¤œç´¢ãƒ–ãƒƒã‚¯ãƒãƒ¼ã‚¯ãƒ¬ãƒƒãƒˆ(å°å…¥ã¯è‡ªå·±è²¬ä»»ã§)</a></li>
  </ul>
  <h4>ãŠçŸ¥ã‚‰ã›</h4>
  <ul>
    <li><strong>ãƒ‡ãƒ¼ã‚¿ã®åé›†ã«é–¢ã—ã¦:</strong>2025å¹´9æœˆ20æ—¥ã®21æ™‚ã‹ã‚‰24æ™‚ã¾ã§ãŠã‚“JãŒè½ã¡ã¾ãã£ã¦ãŸã®ã§ã€ä¸å…·åˆã§åé›†ã•ã‚Œã¦ãªã„ã‚¹ãƒ¬ãŒã‚ã‚Šã¾ã™ã€‚ã™ã¿ã¾ã›ã‚“(ãªãŠã‚ã‚‹ç¨‹åº¦ã®ãƒ‡ãƒ¼ã‚¿å†åé›†ã¯å®Œäº†ã—ã¾ã—ãŸ)</li>
    <li><strong>ãƒ‡ãƒ¼ã‚¿ã®åé›†ã«é–¢ã—ã¦:</strong>2025å¹´9æœˆ27æ—¥ã®10æ™‚50åˆ†ã‹ã‚‰12æ™‚50åˆ†ã¾ã§ãŠã‚“JãŒè½ã¡ã¾ãã£ã¦ãŸã®ã§ã€ä¸å…·åˆã§åé›†ã•ã‚Œã¦ãªã„ã‚¹ãƒ¬ãŒã‚ã‚Šã¾ã™ã€‚ã™ã¿ã¾ã›ã‚“</li>
  </ul>
</div>

<div id="documentsList" class="documents-list">
  <div class="documents-header">
    <span>åˆ©ç”¨å¯èƒ½ãªãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆä¸€è¦§</span>
    <span id="documentsCount"></span>
  </div>
  <div id="documentsContent"></div>
</div>

<div id="info" class="info">ã“ã“ã«ãƒ‡ãƒ¼ã‚¿æƒ…å ±ã‚„æ¤œç´¢çµæœãŒè¡¨ç¤ºã•ã‚Œã¾ã™ã€‚</div>
<div id="searchSummary" class="search-summary" style="display: none;"></div>
<div id="results"></div>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/12.2.1/firebase-app.js";
  import { getFirestore, collection, getDocs, doc, getDoc } from "https://www.gstatic.com/firebasejs/12.2.1/firebase-firestore.js";
  
  const firebaseConfig = {
    apiKey: "AIzaSyA2Z-JByRuaSv88nAj356nOh4CNgQb0_SY",
    authDomain: "onj-zenbun-kensaku.firebaseapp.com",
    projectId: "onj-zenbun-kensaku",
    storageBucket: "onj-zenbun-kensaku.firebasestorage.app",
    messagingSenderId: "171332002735",
    appId: "1:171332002735:web:c8dcad3ae133300900855a",
    measurementId: "G-DDHGB57HTW"
  };
  
  const app = initializeApp(firebaseConfig);
  const db = getFirestore(app);

  let allDocuments = [];
  let allDocumentThreads = new Map(); // ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆID -> ã‚¹ãƒ¬ãƒƒãƒ‰ãƒ‡ãƒ¼ã‚¿ã®ãƒãƒƒãƒ—
  let currentSearchResults = []; // ç¾åœ¨ã®æ¤œç´¢çµæœã‚’ä¿å­˜
  let totalDocumentCount = 0; // ãƒ¡ã‚¿ã‹ã‚‰å–å¾—ã™ã‚‹ç·ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆæ•°
  let fetchedDocumentIds = new Set(); // å–å¾—æ¸ˆã¿ã®ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆIDã‚’è¿½è·¡

  function formatBytes(bytes) {
    if (!bytes || bytes === 0) return '0 B';
    const k = 1024;
    const sizes = ['B', 'KB', 'MB', 'GB'];
    const i = Math.floor(Math.log(bytes) / Math.log(k));
    return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
  }

  function parseDateTime(dateTimeStr) {
    if (!dateTimeStr) return null;
    const match = dateTimeStr.match(/(\d{2})\/(\d{2})\/(\d{2})\([^)]+\)\s+(\d{2}):(\d{2}):(\d{2})/);
    if (!match) return null;
    const [, year, month, day, hour, minute, second] = match;
    const fullYear = parseInt(year) + 2000;
    return new Date(fullYear, parseInt(month) - 1, parseInt(day), parseInt(hour), parseInt(minute), parseInt(second));
  }
  
  function parseContentData(content) {
    const threads = [];
    // ã‚¹ãƒ¬ãƒƒãƒ‰IDã§åˆ†å‰²
    const threadParts = content.split(/=!=!=(\d+)=!=!=/);
    if (threadParts[0] === '') threadParts.shift();
    
    for (let i = 0; i < threadParts.length; i += 2) {
      const threadId = threadParts[i];
      const threadContent = threadParts[i + 1];
      if (!threadId || !threadContent) continue;
      
      // ã‚¹ãƒ¬ãƒƒãƒ‰ã®æœ€çµ‚æ›´æ–°æ™‚åˆ»ã‚’å–å¾—
      const contentParts = threadContent.split('=?=?=');
      let cleanThreadContent = (contentParts.length >= 3) ? contentParts.slice(2).join('=?=?=').trim() : threadContent.trim();
      if (!cleanThreadContent) continue;
      
      // è¡Œã§åˆ†å‰²
      const lines = cleanThreadContent.split('\n');
      let posts = [];
      let threadTitle = "ï¼ˆã‚¿ã‚¤ãƒˆãƒ«ä¸æ˜ï¼‰";
      let lastPostTime = null;
      let postNumber = 0;

      for (let lineIndex = 0; lineIndex < lines.length; lineIndex++) {
        const line = lines[lineIndex].trim();
        if (!line) continue;

        // ãƒ¬ã‚¹ã®é–‹å§‹æ¡ä»¶ã‚’ã‚ˆã‚Šå³å¯†ã«åˆ¤å®š
        // 1. ã€Œåç„¡ã—ã•ã‚“ï¼ ãŠãƒ¼ã·ã‚“<>ã€ã§å§‹ã¾ã‚‹å ´åˆ
        // 2. ã¾ãŸã¯ã€Œåç„¡ã—ã€ã§å§‹ã¾ã‚Šã€Œ<>ã€ã‚’å«ã‚€å ´åˆ
        const isPostStart = line.startsWith('åç„¡ã—ã•ã‚“ï¼ ãŠãƒ¼ã·ã‚“<>') || 
                           (line.startsWith('åç„¡ã—') && line.includes('<>') && line.includes('ID:'));

        if (isPostStart) {
          postNumber++;
          const parts = line.split('<>');
          if (parts.length < 3) continue;

          const author = parts[0].trim();
          let emailOrSage = '';
          let dateTimeAndId = '';
          let postBodyContent = '';
          
          // ãƒ‘ã‚¿ãƒ¼ãƒ³åˆ¤å®š: åå‰<>sage<>æ—¥æ™‚ ID<>å†…å®¹ ã¾ãŸã¯ åå‰<><>æ—¥æ™‚ ID<>å†…å®¹
          if (parts.length >= 4 && parts[2].match(/\d{2}\/\d{2}\/\d{2}/)) {
            emailOrSage = parts[1] || '';
            dateTimeAndId = parts[2];
            postBodyContent = parts.slice(3).join('<>');
          } else if (parts.length >= 3 && parts[1].match(/\d{2}\/\d{2}\/\d{2}/)) {
            dateTimeAndId = parts[1];
            postBodyContent = parts.slice(2).join('<>');
          } else {
            // æ—¥æ™‚ãŒãªã„å ´åˆã®å‡¦ç†ï¼ˆIDã®ã¿ã®ãƒ‘ã‚¿ãƒ¼ãƒ³ï¼‰
            for (let j = 1; j < parts.length; j++) {
              if (parts[j].includes('ID:')) {
                dateTimeAndId = parts[j];
                postBodyContent = parts.slice(j + 1).join('<>');
                break;
              }
            }
          }

          // æ—¥æ™‚ã¨IDã‚’åˆ†é›¢
          let postTime = '';
          let userId = '';
          
          if (dateTimeAndId.includes('ID:')) {
            const dateIdMatch = dateTimeAndId.match(/^(.+?)\s+ID:\s*(\S+)$/);
            if (dateIdMatch) {
              [, postTime, userId] = dateIdMatch;
            } else {
              // ID:ã®ã¿ã®å ´åˆ
              const idMatch = dateTimeAndId.match(/ID:\s*(\S+)/);
              if (idMatch) {
                userId = idMatch[1];
                postTime = 'ä¸æ˜';
              }
            }
          }

          const parsedTime = parseDateTime(postTime);
          if (parsedTime) lastPostTime = parsedTime;

          // 1ãƒ¬ã‚¹ç›®ã®å ´åˆã€ã‚¹ãƒ¬ãƒƒãƒ‰ã‚¿ã‚¤ãƒˆãƒ«ã‚’æŠ½å‡º
          if (postNumber === 1 && postBodyContent) {
            const bodyParts = postBodyContent.split('<>');
            let titleCandidate = '';
            
            // æœ€å¾Œã®æœ‰åŠ¹ãªãƒ‘ãƒ¼ãƒˆã‚’æ¢ã™ï¼ˆURLã‚„IDã‚’é™¤ãï¼‰
            for (let j = bodyParts.length - 1; j >= 0; j--) {
              const part = bodyParts[j].trim();
              if (part && part.length >= 1) {
                titleCandidate = part;
                break;
              }
            }
            
            if (titleCandidate) {
              threadTitle = titleCandidate;
              // ã‚¿ã‚¤ãƒˆãƒ«éƒ¨åˆ†ã‚’é™¤ã„ãŸå†…å®¹ã‚’æŠ•ç¨¿å†…å®¹ã¨ã™ã‚‹
              const titleIndex = postBodyContent.lastIndexOf('<>' + titleCandidate);
              if (titleIndex !== -1) {
                postBodyContent = postBodyContent.substring(0, titleIndex).replace(/<>$/, '').trim();
              }
            }
          }
          
          posts.push({
            postNumber: postNumber,
            author: author,
            sage: emailOrSage === 'sage',
            postTime: postTime || 'ä¸æ˜',
            postTimeDate: parsedTime,
            userId: userId || 'ä¸æ˜',
            content: postBodyContent.replace(/<br>/g, '\n').trim()
          });
        }
      }
      
      if (posts.length > 0) {
        threads.push({
          id: threadId,
          title: threadTitle,
          link: `https://hayabusa.open2ch.net/test/read.cgi/livejupiter/${threadId}/`,
          posts: posts,
          lastUpdated: posts[posts.length - 1].postTime,
          lastUpdatedDate: lastPostTime
        });
      }
    }
    return threads;
  }
  
  async function initializeSystem() {
    const infoDiv = document.getElementById('info');
    try {
      infoDiv.innerHTML = '<div class="loading">ã‚·ã‚¹ãƒ†ãƒ ã‚’åˆæœŸåŒ–ä¸­...</div>';
      const metaDocRef = doc(db, "meta", "document_count");
      const metaDocSnap = await getDoc(metaDocRef);

      if (metaDocSnap.exists()) {
        totalDocumentCount = metaDocSnap.data().totalDocuments;
        const fetchCountInput = document.getElementById('fetchCount');
        fetchCountInput.max = totalDocumentCount;
        if (parseInt(fetchCountInput.value, 10) > totalDocumentCount) {
            fetchCountInput.value = totalDocumentCount;
        }
        infoDiv.innerHTML = `æº–å‚™å®Œäº†ã€‚å…¨${totalDocumentCount}ä»¶ã®ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã‹ã‚‰æ¤œç´¢ã§ãã¾ã™ã€‚`;
      } else {
        totalDocumentCount = 0;
        infoDiv.textContent = 'ã‚¨ãƒ©ãƒ¼: ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆæ•°ã®ãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚';
      }
    } catch (err) {
      infoDiv.textContent = `åˆæœŸåŒ–ã‚¨ãƒ©ãƒ¼: ${err.message}`;
      console.error(err);
    }
    checkUrlParams();
  }

  async function fetchRequiredDocuments() {
    const fetchAll = document.getElementById('fetchAllDocs').checked;
    const fetchCountInput = document.getElementById('fetchCount');
    let numToFetch = parseInt(fetchCountInput.value, 10);

    if (isNaN(numToFetch) || numToFetch <= 0) {
      numToFetch = 1;
      fetchCountInput.value = '1';
    }

    const docIdsToRequest = new Set();
    if (fetchAll) {
      for (let i = 1; i <= totalDocumentCount; i++) docIdsToRequest.add(String(i));
    } else {
      const startId = totalDocumentCount;
      const endId = Math.max(1, totalDocumentCount - numToFetch + 1);
      for (let i = startId; i >= endId; i--) docIdsToRequest.add(String(i));
    }

    const newDocIdsToFetch = [...docIdsToRequest].filter(id => !fetchedDocumentIds.has(id));
    if (newDocIdsToFetch.length === 0) {
      updateInfoPanel();
      return true;
    }

    const infoDiv = document.getElementById('info');
    infoDiv.innerHTML = `<div class="loading">${newDocIdsToFetch.length}ä»¶ã®æ–°è¦ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã‚’èª­ã¿è¾¼ã¿ä¸­...</div>`;

    try {
      const fetchPromises = newDocIdsToFetch.map(id => getDoc(doc(db, "aggregated_threads", id)));
      const docSnapshots = await Promise.all(fetchPromises);

      for (const docSnapshot of docSnapshots) {
        if (docSnapshot.exists()) {
          const docId = docSnapshot.id;
          const data = docSnapshot.data();
          const threads = parseContentData(data.content || '');
          allDocumentThreads.set(docId, threads);
          
          if (!allDocuments.some(d => d.id === docId)) {
            const contentSize = data.content ? new Blob([data.content]).size : 0;
            const lastUpdated = data.lastUpdated ? new Date(data.lastUpdated.seconds * 1000).toLocaleString('ja-JP') : 'ä¸æ˜';
            const threadCount = threads.length;
            const postCount = threads.reduce((sum, t) => sum + t.posts.length, 0);
            allDocuments.push({
              id: docId, name: docId, size: contentSize, lastUpdated: lastUpdated,
              threadCount: threadCount, postCount: postCount, data: data
            });
          }
          fetchedDocumentIds.add(docId);
        }
      }
      
      allDocuments.sort((a, b) => a.name.localeCompare(b.name, undefined, {numeric: true}));
      renderDocumentsList();
      updateInfoPanel();
      return true;
    } catch (err) {
      infoDiv.textContent = `ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã®èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼: ${err.message}`;
      console.error(err);
      return false;
    }
  }

  function renderDocumentsList() {
    const documentsContent = document.getElementById('documentsContent');
    const documentsCount = document.getElementById('documentsCount');
    
    documentsCount.textContent = `${allDocuments.length}ä»¶ã®ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ (èª­ã¿è¾¼ã¿æ¸ˆã¿)`;
    documentsContent.innerHTML = '';
    
    allDocuments.forEach(doc => {
      const docDiv = document.createElement('div');
      docDiv.className = 'document-item';
      docDiv.innerHTML = `
        <div class="document-name">${doc.name}</div>
        <div class="document-info">
          <span class="document-size">${formatBytes(doc.size)}</span>
          <span class="document-stats">ã‚¹ãƒ¬ãƒƒãƒ‰: ${doc.threadCount}ä»¶, æŠ•ç¨¿: ${doc.postCount}ä»¶</span>
          <span>æ›´æ–°: ${doc.lastUpdated}</span>
        </div>
      `;
      documentsContent.appendChild(docDiv);
    });
  }

  function toggleDocumentsList() {
    const docsList = document.getElementById('documentsList');
    docsList.style.display = (docsList.style.display === 'none' || docsList.style.display === '') ? 'block' : 'none';
  }

  function toggleHelpPanel() {
    const helpPanel = document.getElementById('helpPanel');
    helpPanel.style.display = (helpPanel.style.display === 'none' || helpPanel.style.display === '') ? 'block' : 'none';
  }

  function updateInfoPanel() {
    if (allDocumentThreads.size > 0) {
        const totalThreads = Array.from(allDocumentThreads.values()).reduce((sum, threads) => sum + threads.length, 0);
        const totalPosts = Array.from(allDocumentThreads.values()).reduce((sum, threads) => sum + threads.reduce((s, t) => s + t.posts.length, 0), 0);
        document.getElementById('info').innerHTML = `
          <strong>æ¤œç´¢å¯¾è±¡:</strong> ${allDocumentThreads.size}ä»¶ã®ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã‚’èª­ã¿è¾¼ã¿æ¸ˆã¿ | 
          <strong>ç·ã‚¹ãƒ¬ãƒƒãƒ‰æ•°:</strong> ${totalThreads} | 
          <strong>ç·æŠ•ç¨¿æ•°:</strong> ${totalPosts}
        `;
    } else {
        document.getElementById('info').innerHTML = `æº–å‚™å®Œäº†ã€‚å…¨${totalDocumentCount}ä»¶ã®ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã‹ã‚‰æ¤œç´¢ã§ãã¾ã™ã€‚`;
    }
  }

  function highlightSearchTerm(text, term) {
    if (!term || !text) return text;
    let termToHighlight = term;
    const idSearchMatch = term.match(/^id:\s*(.*)/i);
    if (idSearchMatch) termToHighlight = idSearchMatch[1].trim().replace(/\s/g, '');
    if (!termToHighlight) return text;
    const escapedTerm = termToHighlight.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
    const regex = new RegExp(`(${escapedTerm})`, 'gi');
    return text.replace(regex, '<span class="highlight">$1</span>');
  }

  function processAnchors(content, thread) {
    // ã‚¨ã‚¹ã‚±ãƒ¼ãƒ—ã•ã‚ŒãŸå®‰ä¾¡ï¼ˆ&gt;&gt;æ•°å­—ï¼‰ã¨é€šå¸¸ã®å®‰ä¾¡ï¼ˆ>>æ•°å­—ï¼‰ã®ä¸¡æ–¹ã‚’å‡¦ç†
    return content.replace(/(&gt;&gt;\d+|>>\d+)/g, (match) => {
      const postNum = match.replace(/&gt;&gt;|>>/, '');
      return `<span class="anchor-link" data-post-num="${postNum}" data-thread-id="${thread.id}">${match}</span>`;
    });
  }

  function embedMedia(content) {
    // URLãƒ‘ã‚¿ãƒ¼ãƒ³ã®å®šç¾©
    const urlPattern = /https?:\/\/[^\s<>]+/g;
    const processedUrls = new Set();
    
    return content.replace(urlPattern, (url) => {
      // åŒã˜URLã‚’è¤‡æ•°å›å‡¦ç†ã—ãªã„ã‚ˆã†ã«ã™ã‚‹
      if (processedUrls.has(url)) return url;
      processedUrls.add(url);
      
      let embedHtml = '';
      
      // imgurç”»åƒ
      if (url.match(/https?:\/\/(?:i\.)?imgur\.com\/([a-zA-Z0-9]+)(?:\.[a-zA-Z]+)?/)) {
        const imgId = url.match(/\/([a-zA-Z0-9]+)(?:\.[a-zA-Z]+)?$/)[1];
        embedHtml = `<div class="media-embed"><img src="https://i.imgur.com/${imgId}.jpg" alt="imgur image" loading="lazy" onerror="this.parentElement.style.display='none'"></div>`;
      }
      // YouTube
      else if (url.match(/(?:youtube\.com\/watch\?v=|youtu\.be\/)([a-zA-Z0-9_-]+)/)) {
        const videoId = url.match(/(?:youtube\.com\/watch\?v=|youtu\.be\/)([a-zA-Z0-9_-]+)/)[1];
        embedHtml = `<div class="media-embed"><iframe src="https://www.youtube.com/embed/${videoId}" allowfullscreen loading="lazy"></iframe></div>`;
      }
      // X (Twitter)
      else if (url.match(/https?:\/\/(?:twitter\.com|x\.com)\/[^\/]+\/status\/(\d+)/)) {
        const tweetId = url.match(/\/status\/(\d+)/)[1];
        const tweetUrl = encodeURIComponent(url);
        embedHtml = `<div class="media-embed media-embed-x"><iframe src="https://platform.twitter.com/embed/Tweet.html?id=${tweetId}" loading="lazy"></iframe></div>`;
      }
      
      // åŸ‹ã‚è¾¼ã¿HTMLãŒã‚ã‚‹å ´åˆã¯ã€URLã®ä¸Šã«é…ç½®
      return embedHtml ? embedHtml + url : url;
    });
  }

  function createAnchorPreview(postNum, threadId) {
    const threads = Array.from(allDocumentThreads.values()).flat();
    const thread = threads.find(t => t.id === threadId);
    if (!thread) return null;

    const targetPost = thread.posts.find(p => p.postNumber === parseInt(postNum));
    if (!targetPost) return null;

    const previewDiv = document.createElement('div');
    previewDiv.className = 'anchor-preview';
    const cleanContent = targetPost.content.replace(/ <>$/, '').trim();
    previewDiv.innerHTML = `
      <div class="preview-meta">${targetPost.postNumber}: ${targetPost.author} | ${targetPost.postTime} | ID:${targetPost.userId}</div>
      <div class="preview-content">${cleanContent.substring(0, 200)}${cleanContent.length > 200 ? '...' : ''}</div>
    `;
    return previewDiv;
  }

  // å®‰ä¾¡å…ˆã®ãƒ¬ã‚¹ã‚’è¡¨ç¤ºã™ã‚‹é–¢æ•°
  function showAnchorPost(postNum, threadId) {
    const threads = Array.from(allDocumentThreads.values()).flat();
    const thread = threads.find(t => t.id === threadId);
    if (!thread) return;

    const targetPost = thread.posts.find(p => p.postNumber === parseInt(postNum));
    if (!targetPost) return;

    // è©²å½“ã‚¹ãƒ¬ãƒƒãƒ‰ã®è¦ç´ ã‚’æ¢ã™
    const threadElements = document.querySelectorAll('.thread-result');
    let targetThreadElement = null;
    
    threadElements.forEach(element => {
      const threadTitle = element.querySelector('.thread-title');
      if (threadTitle && threadTitle.textContent.includes(thread.title)) {
        targetThreadElement = element;
      }
    });

    if (targetThreadElement) {
      // ã‚¹ãƒ¬ãƒƒãƒ‰ã®è©³ç´°ã‚’å±•é–‹
      const detailsDiv = targetThreadElement.querySelector('.thread-details');
      detailsDiv.style.display = 'block';
      
      // æ—¢å­˜ã®ãƒ¬ã‚¹ãŒã‚ã‚‹ã‹ç¢ºèª
      const existingPosts = detailsDiv.querySelectorAll('.post');
      let targetPostElement = null;
      
      existingPosts.forEach(postElement => {
        const postMeta = postElement.querySelector('.post-meta strong');
        if (postMeta && postMeta.textContent.startsWith(postNum + ':')) {
          targetPostElement = postElement;
        }
      });

      // ãƒ¬ã‚¹ãŒè¡¨ç¤ºã•ã‚Œã¦ã„ãªã„å ´åˆã¯è¿½åŠ 
      if (!targetPostElement) {
        const postDiv = document.createElement('div');
        postDiv.className = 'post';
        const cleanContent = targetPost.content.replace(/ <>$/, '').trim();
        let postContent = processAnchors(cleanContent, thread);
        postContent = embedMedia(postContent);
        const sageIndicator = targetPost.sage ? ' <span style="color: #888; font-size: 0.9em;">[sage]</span>' : '';
        
        postDiv.innerHTML = `
          <div class="post-meta">
            <strong data-thread-id="${thread.id}" data-post-num="${targetPost.postNumber}">${targetPost.postNumber}: ${targetPost.author}</strong>${sageIndicator} | æ™‚åˆ»: ${targetPost.postTime} | ID:${targetPost.userId}
            <div class="post-buttons">
              <button class="range-up" data-post-num="${targetPost.postNumber}">ä¸Š100ãƒ¬ã‚¹</button>
              <button class="range-down" data-post-num="${targetPost.postNumber}">ä¸‹100ãƒ¬ã‚¹</button>
              <button class="copy-btn" data-post-data="${targetPost.postNumber}: ${targetPost.author} | æ™‚åˆ»: ${targetPost.postTime} | ID:${targetPost.userId}
${cleanContent}">ã‚³ãƒ”ãƒš</button>
            </div>
          </div>
          <div class="post-content">${postContent}</div>
        `;
        
        detailsDiv.appendChild(postDiv);
        targetPostElement = postDiv;
        
        // ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ã‚’è¿½åŠ 
        addPostEventListeners(postDiv, thread);
      }

      // ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ã—ã¦è¡¨ç¤º
      targetPostElement.scrollIntoView({ behavior: 'smooth', block: 'center' });
      targetPostElement.style.backgroundColor = '#ffffcc';
      setTimeout(() => {
        targetPostElement.style.backgroundColor = '';
      }, 2000);
    }
  }

  function sortSearchResults(results, sortOrder) {
    const sortedResults = [...results];
    switch (sortOrder) {
      case 'newest':
        sortedResults.sort((a, b) => (b.lastUpdatedDate || 0) - (a.lastUpdatedDate || 0));
        break;
      case 'oldest':
        sortedResults.sort((a, b) => (a.lastUpdatedDate || 0) - (b.lastUpdatedDate || 0));
        break;
      case 'document':
        sortedResults.sort((a, b) => (a.documentName || '').localeCompare(b.documentName || '', undefined, {numeric: true}));
        break;
      case 'relevance':
        sortedResults.sort((a, b) => b.matchedPosts.length - a.matchedPosts.length);
        break;
    }
    return sortedResults;
  }

  // ãƒ¬ã‚¹ç¯„å›²è¡¨ç¤ºæ©Ÿèƒ½ï¼ˆæ”¹è‰¯ç‰ˆï¼šã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ä½ç½®ã‚’ç¶­æŒï¼‰
  function showPostsInRange(thread, postElement, direction, keyword, button) {
    // é€£æ‰“é˜²æ­¢ï¼šãƒœã‚¿ãƒ³ã‚’ç„¡åŠ¹åŒ–
    button.disabled = true;
    button.textContent = 'èª­è¾¼ä¸­...';
    
    // ç¾åœ¨ã®ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ä½ç½®ã¨è¦ç´ ã®ä½ç½®ã‚’è¨˜æ†¶
    const originalScrollTop = window.pageYOffset;
    const originalElementTop = postElement.getBoundingClientRect().top;
    
    const postNumber = parseInt(postElement.querySelector('.post-meta strong').textContent.split(':')[0]);
    let startIndex, endIndex;
    
    if (direction === 'up') {
      // ä¸Š100ãƒ¬ã‚¹: ãƒ¬ã‚¹ç•ªå·-100ã‹ã‚‰-1ã¾ã§
      startIndex = Math.max(0, postNumber - 100 - 1);
      endIndex = Math.max(0, postNumber - 1);
    } else {
      // ä¸‹100ãƒ¬ã‚¹: ãƒ¬ã‚¹ç•ªå·+1ã‹ã‚‰+100ã¾ã§  
      startIndex = Math.min(thread.posts.length - 1, postNumber);
      endIndex = Math.min(thread.posts.length, postNumber + 100);
    }
    
    const postsToShow = thread.posts.slice(startIndex, endIndex);
    const container = document.createElement('div');
    container.className = `range-posts range-posts-${direction}`;
    
    postsToShow.forEach(post => {
      const postDiv = document.createElement('div');
      postDiv.className = 'post';
      
      const cleanContent = post.content.replace(/ <>$/, '').trim();
      let postContent = processAnchors(cleanContent, thread);
      postContent = embedMedia(postContent);
      const highlightedContent = highlightSearchTermInPost(post, keyword) ? highlightSearchTerm(postContent, keyword) : postContent;
      const highlightedAuthor = highlightSearchTerm(post.author, keyword);
      const highlightedUserId = highlightSearchTerm(post.userId, keyword);
      const sageIndicator = post.sage ? ' <span style="color: #888; font-size: 0.9em;">[sage]</span>' : '';
      
      postDiv.innerHTML = `
        <div class="post-meta">
          <strong data-thread-id="${thread.id}" data-post-num="${post.postNumber}">${post.postNumber}: ${highlightedAuthor}</strong>${sageIndicator} | æ™‚åˆ»: ${post.postTime} | ID:${highlightedUserId}
          <div class="post-buttons">
            <button class="copy-btn" data-post-data="${post.postNumber}: ${post.author} | æ™‚åˆ»: ${post.postTime} | ID:${post.userId}
${cleanContent}">ã‚³ãƒ”ãƒš</button>
          </div>
        </div>
        <div class="post-content">${highlightedContent}</div>
      `;
      container.appendChild(postDiv);
      
      // ãƒ¬ã‚¹ç•ªå·ã‚¯ãƒªãƒƒã‚¯ã‚¤ãƒ™ãƒ³ãƒˆã‚’è¿½åŠ 
      const postNumElement = postDiv.querySelector('.post-meta strong');
      postNumElement.addEventListener('click', (e) => {
        e.stopPropagation();
        const postNum = postNumElement.getAttribute('data-post-num');
        const threadId = postNumElement.getAttribute('data-thread-id');
        window.open(`https://hayabusa.open2ch.net/test/read.cgi/livejupiter/${threadId}/${postNum}-`, '_blank');
      });

      // ã‚³ãƒ”ãƒ¼ãƒœã‚¿ãƒ³ã®ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ã‚’è¿½åŠ 
      const copyBtn = postDiv.querySelector('.copy-btn');
      copyBtn.addEventListener('click', (e) => {
        e.stopPropagation();
        const postData = copyBtn.getAttribute('data-post-data');
        navigator.clipboard.writeText(postData).then(() => {
          const originalText = copyBtn.textContent;
          copyBtn.textContent = 'ã‚³ãƒ”ãƒ¼å®Œäº†';
          setTimeout(() => {
            copyBtn.textContent = originalText;
          }, 1000);
        }).catch(() => {
          prompt('ä»¥ä¸‹ã‚’ã‚³ãƒ”ãƒ¼ã—ã¦ãã ã•ã„:', postData);
        });
      });
    });

    if (direction === 'up') {
      postElement.parentNode.insertBefore(container, postElement);
      
      // ä¸Š100ãƒ¬ã‚¹ã®å ´åˆï¼šã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ä½ç½®ã‚’èª¿æ•´ã—ã¦å…ƒã®ä½ç½®ã‚’ç¶­æŒ
      setTimeout(() => {
        const newElementTop = postElement.getBoundingClientRect().top;
        const scrollAdjustment = newElementTop - originalElementTop;
        window.scrollTo(0, originalScrollTop + scrollAdjustment);
      }, 0);
    } else {
      postElement.parentNode.insertBefore(container, postElement.nextSibling);
    }

    // å®‰ä¾¡ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚¤ãƒ™ãƒ³ãƒˆã‚’è¿½åŠ 
    addAnchorPreviewEvents(container);

    // ãƒœã‚¿ãƒ³ã‚’å…ƒã«æˆ»ã™ï¼ˆã—ã‹ã—ç„¡åŠ¹åŒ–ã¯ç¶™ç¶šï¼‰
    setTimeout(() => {
      button.textContent = direction === 'up' ? 'ä¸Š100ãƒ¬ã‚¹' : 'ä¸‹100ãƒ¬ã‚¹';
      // ãƒœã‚¿ãƒ³ã¯ç„¡åŠ¹åŒ–ã—ãŸã¾ã¾ï¼ˆé€£æ‰“é˜²æ­¢ï¼‰
    }, 500);
  }

  function showAllPosts(thread, keyword, threadDiv) {
    const detailsDiv = threadDiv.querySelector('.thread-details');
    
    // æ—¢å­˜ã®ç¯„å›²è¡¨ç¤ºã‚’ã™ã¹ã¦å‰Šé™¤
    const rangeElements = detailsDiv.querySelectorAll('.range-posts');
    rangeElements.forEach(el => el.remove());
    
    // æ—¢å­˜ã®ãƒãƒƒãƒã—ãŸãƒ¬ã‚¹ã‚’ã™ã¹ã¦å‰Šé™¤
    const existingPosts = detailsDiv.querySelectorAll('.post');
    existingPosts.forEach(post => post.remove());
    
    const postsContainer = detailsDiv.querySelector('.posts-container') || (() => {
      const container = document.createElement('div');
      container.className = 'posts-container';
      detailsDiv.appendChild(container);
      return container;
    })();
    
    postsContainer.innerHTML = '';
    
    thread.posts.forEach(post => {
      const postDiv = document.createElement('div');
      postDiv.className = 'post';
      
      const cleanContent = post.content.replace(/ <>$/, '').trim();
      let postContent = processAnchors(cleanContent, thread);
      postContent = embedMedia(postContent);
      const highlightedContent = highlightSearchTermInPost(post, keyword) ? highlightSearchTerm(postContent, keyword) : postContent;
      const highlightedAuthor = highlightSearchTerm(post.author, keyword);
      const highlightedUserId = highlightSearchTerm(post.userId, keyword);
      const sageIndicator = post.sage ? ' <span style="color: #888; font-size: 0.9em;">[sage]</span>' : '';
      
      postDiv.innerHTML = `
        <div class="post-meta">
          <strong data-thread-id="${thread.id}" data-post-num="${post.postNumber}">${post.postNumber}: ${highlightedAuthor}</strong>${sageIndicator} | æ™‚åˆ»: ${post.postTime} | ID:${highlightedUserId}
          <div class="post-buttons">
            <button class="copy-btn" data-post-data="${post.postNumber}: ${post.author} | æ™‚åˆ»: ${post.postTime} | ID:${post.userId}
${cleanContent}">ã‚³ãƒ”ãƒš</button>
          </div>
        </div>
        <div class="post-content">${highlightedContent}</div>
      `;
      postsContainer.appendChild(postDiv);
      
      // ãƒ¬ã‚¹ç•ªå·ã‚¯ãƒªãƒƒã‚¯ã‚¤ãƒ™ãƒ³ãƒˆã‚’è¿½åŠ 
      const postNumElement = postDiv.querySelector('.post-meta strong');
      postNumElement.addEventListener('click', (e) => {
        e.stopPropagation();
        const postNum = postNumElement.getAttribute('data-post-num');
        const threadId = postNumElement.getAttribute('data-thread-id');
        window.open(`https://hayabusa.open2ch.net/test/read.cgi/livejupiter/${threadId}/${postNum}-`, '_blank');
      });

      // ã‚³ãƒ”ãƒ¼ãƒœã‚¿ãƒ³ã®ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ã‚’è¿½åŠ 
      const copyBtn = postDiv.querySelector('.copy-btn');
      copyBtn.addEventListener('click', (e) => {
        e.stopPropagation();
        const postData = copyBtn.getAttribute('data-post-data');
        navigator.clipboard.writeText(postData).then(() => {
          const originalText = copyBtn.textContent;
          copyBtn.textContent = 'ã‚³ãƒ”ãƒ¼å®Œäº†';
          setTimeout(() => {
            copyBtn.textContent = originalText;
          }, 1000);
        }).catch(() => {
          prompt('ä»¥ä¸‹ã‚’ã‚³ãƒ”ãƒ¼ã—ã¦ãã ã•ã„:', postData);
        });
      });
    });

    // å®‰ä¾¡ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚¤ãƒ™ãƒ³ãƒˆã‚’è¿½åŠ 
    addAnchorPreviewEvents(postsContainer);
  }

  function addPostEventListeners(postDiv, thread) {
    // ä¸Š100ãƒ¬ã‚¹ãƒ»ä¸‹100ãƒ¬ã‚¹ãƒœã‚¿ãƒ³ã®ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼
    const upButton = postDiv.querySelector('.range-up');
    const downButton = postDiv.querySelector('.range-down');
    const keyword = document.getElementById('searchInput').value.trim();
    
    if (upButton) {
      upButton.addEventListener('click', (e) => {
        e.stopPropagation();
        if (!upButton.disabled) {
          showPostsInRange(thread, postDiv, 'up', keyword, upButton);
        }
      });
    }
    
    if (downButton) {
      downButton.addEventListener('click', (e) => {
        e.stopPropagation();
        if (!downButton.disabled) {
          showPostsInRange(thread, postDiv, 'down', keyword, downButton);
        }
      });
    }
    
    // ã‚³ãƒ”ãƒ¼ãƒœã‚¿ãƒ³ã®ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼
    const copyBtn = postDiv.querySelector('.copy-btn');
    if (copyBtn) {
      copyBtn.addEventListener('click', (e) => {
        e.stopPropagation();
        const postData = copyBtn.getAttribute('data-post-data');
        navigator.clipboard.writeText(postData).then(() => {
          const originalText = copyBtn.textContent;
          copyBtn.textContent = 'ã‚³ãƒ”ãƒ¼å®Œäº†';
          setTimeout(() => {
            copyBtn.textContent = originalText;
          }, 1000);
        }).catch(() => {
          prompt('ä»¥ä¸‹ã‚’ã‚³ãƒ”ãƒ¼ã—ã¦ãã ã•ã„:', postData);
        });
      });
    }
    
    // ãƒ¬ã‚¹ç•ªå·ã‚¯ãƒªãƒƒã‚¯ã‚¤ãƒ™ãƒ³ãƒˆã‚’è¿½åŠ 
    const postNumElement = postDiv.querySelector('.post-meta strong');
    if (postNumElement) {
      postNumElement.addEventListener('click', (e) => {
        e.stopPropagation();
        const postNum = postNumElement.getAttribute('data-post-num');
        const threadId = postNumElement.getAttribute('data-thread-id');
        window.open(`https://hayabusa.open2ch.net/test/read.cgi/livejupiter/${threadId}/${postNum}-`, '_blank');
      });
    }
  }

  function addAnchorPreviewEvents(container) {
  const anchorLinks = container.querySelectorAll('.anchor-link');
  anchorLinks.forEach(link => {
    let previewElement = null;
    
    link.addEventListener('mouseenter', (e) => {
      const postNum = e.target.getAttribute('data-post-num');
      const threadId = e.target.getAttribute('data-thread-id');
      previewElement = createAnchorPreview(postNum, threadId);
      
      if (previewElement) {
        document.body.appendChild(previewElement);
        const rect = e.target.getBoundingClientRect();

        // æ¨ªä½ç½®ï¼ˆã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ã‚’è€ƒæ…®ï¼‰
        previewElement.style.left = Math.min(
          rect.left + window.scrollX,
          window.innerWidth - previewElement.offsetWidth - 10
        ) + 'px';

        // ç¸¦ä½ç½®ï¼ˆãƒªãƒ³ã‚¯ã®ä¸Šã«è¡¨ç¤ºã€ã¯ã¿å‡ºã—ãŸã‚‰ä¸‹ã«è¡¨ç¤ºï¼‰
        let topPos = rect.top - previewElement.offsetHeight - 5 + window.scrollY;
        if (topPos < window.scrollY) {
          topPos = rect.bottom + 5 + window.scrollY;
        }
        previewElement.style.top = topPos + 'px';
      }
    });
    
    link.addEventListener('mouseleave', () => {
      if (previewElement) {
        document.body.removeChild(previewElement);
        previewElement = null;
      }
    });
    
    // å®‰ä¾¡ã‚¯ãƒªãƒƒã‚¯ã‚¤ãƒ™ãƒ³ãƒˆ
    link.addEventListener('click', (e) => {
      e.preventDefault();
      e.stopPropagation();
      const postNum = e.target.getAttribute('data-post-num');
      const threadId = e.target.getAttribute('data-thread-id');
      showAnchorPost(postNum, threadId);
    });
  });
}

  // OR/ANDæ¤œç´¢ã®ãƒ˜ãƒ«ãƒ‘ãƒ¼é–¢æ•°
  function highlightSearchTermInPost(post, keyword) {
    const cleanContent = post.content.toLowerCase();
    const authorLower = post.author.toLowerCase();
    const userIdLower = post.userId.toLowerCase().replace(/\s/g, '');
    const keywordLower = keyword.toLowerCase();
    const keywordForId = keywordLower.replace(/\s/g, '');
    
    return cleanContent.includes(keywordLower) || 
           authorLower.includes(keywordLower) || 
           userIdLower.includes(keywordForId);
  }

  function renderSearchResults(results, keyword) {
    const resultsDiv = document.getElementById('results');
    const summaryDiv = document.getElementById('searchSummary');
    const sortOptionsDiv = document.getElementById('sortOptions');
    
    resultsDiv.innerHTML = '';

    if (results.length === 0) {
        resultsDiv.innerHTML = '<p>æ¤œç´¢æ¡ä»¶ã«ä¸€è‡´ã™ã‚‹ã‚¹ãƒ¬ãƒƒãƒ‰ãŒã‚ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚</p>';
        summaryDiv.style.display = 'none';
        sortOptionsDiv.style.display = 'none';
        return;
    }

    sortOptionsDiv.style.display = 'block';
    const totalMatches = results.reduce((sum, r) => sum + r.matchedPosts.length, 0);
    summaryDiv.innerHTML = `
      <strong>æ¤œç´¢çµæœ:</strong> "${keyword}" | 
      <strong>å¯¾è±¡:</strong> ${fetchedDocumentIds.size}ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ | 
      <strong>ãƒ’ãƒƒãƒˆ:</strong> ${results.length}ã‚¹ãƒ¬ãƒƒãƒ‰, ${totalMatches}æŠ•ç¨¿
    `;
    summaryDiv.style.display = 'block';

    results.forEach(thread => {
        const threadDiv = document.createElement('div');
        threadDiv.className = 'thread-result';
        const headerDiv = document.createElement('div');
        headerDiv.className = 'thread-header';
        headerDiv.innerHTML = `
            <div class="thread-title-wrapper">
                <span class="thread-title">${highlightSearchTerm(thread.title, keyword)}</span>
                ${thread.documentName ? `<div class="document-source">å‡ºå…¸: ${thread.documentName}</div>` : ''}
                <div class="last-updated">æœ€çµ‚æ›´æ–°: ${thread.lastUpdated}</div>
            </div>
            <div class="thread-stats">
                <span class="total-posts">å…¨${thread.posts.length}ãƒ¬ã‚¹</span>
                <span class="match-count">${thread.matchedPosts.length}ä»¶ãƒ’ãƒƒãƒˆ</span>
            </div>
        `;
        
        const detailsDiv = document.createElement('div');
        detailsDiv.className = 'thread-details';
        detailsDiv.innerHTML = `
          <div class="thread-meta">
            <a href="${thread.link}" target="_blank" rel="noopener noreferrer">ã“ã®ã‚¹ãƒ¬ãƒƒãƒ‰ã¸ã®ãƒªãƒ³ã‚¯</a>
            <button class="show-all-posts" data-thread-id="${thread.id}">å…¨ãƒ¬ã‚¹è¡¨ç¤º</button>
          </div>
        `;

        // å…¨ãƒ¬ã‚¹è¡¨ç¤ºãƒœã‚¿ãƒ³ã®ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼
        const showAllButton = detailsDiv.querySelector('.show-all-posts');
        showAllButton.addEventListener('click', (e) => {
          e.stopPropagation();
          showAllPosts(thread, keyword, threadDiv);
          showAllButton.style.display = 'none';
        });

        // åˆæœŸè¡¨ç¤ºï¼šãƒãƒƒãƒã—ãŸãƒ¬ã‚¹ã®ã¿è¡¨ç¤º
        thread.matchedPosts.forEach(post => {
            const postDiv = document.createElement('div');
            postDiv.className = 'post';
            
            const cleanContent = post.content.replace(/ <>$/, '').trim();
            let postContent = processAnchors(cleanContent, thread);
            postContent = embedMedia(postContent);
            const highlightedContent = highlightSearchTermInPost(post, keyword) ? highlightSearchTerm(postContent, keyword) : postContent;
            const highlightedAuthor = highlightSearchTerm(post.author, keyword);
            const highlightedUserId = highlightSearchTerm(post.userId, keyword);
            const sageIndicator = post.sage ? ' <span style="color: #888; font-size: 0.9em;">[sage]</span>' : '';
            
            postDiv.innerHTML = `
                <div class="post-meta">
                  <strong data-thread-id="${thread.id}" data-post-num="${post.postNumber}">${post.postNumber}: ${highlightedAuthor}</strong>${sageIndicator} | æ™‚åˆ»: ${post.postTime} | ID:${highlightedUserId}
                  <div class="post-buttons">
                    <button class="range-up" data-post-num="${post.postNumber}">ä¸Š100ãƒ¬ã‚¹</button>
                    <button class="range-down" data-post-num="${post.postNumber}">ä¸‹100ãƒ¬ã‚¹</button>
                    <button class="copy-btn" data-post-data="${post.postNumber}: ${post.author} | æ™‚åˆ»: ${post.postTime} | ID:${post.userId}
${cleanContent}">ã‚³ãƒ”ãƒš</button>
                  </div>
                </div>
                <div class="post-content">${highlightedContent}</div>
            `;
            
            // ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ã‚’è¿½åŠ 
            addPostEventListeners(postDiv, thread);
            
            detailsDiv.appendChild(postDiv);
        });

        // å®‰ä¾¡ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚¤ãƒ™ãƒ³ãƒˆã‚’è¿½åŠ 
        addAnchorPreviewEvents(detailsDiv);

        headerDiv.addEventListener('click', () => { 
          detailsDiv.style.display = (detailsDiv.style.display === 'none' || detailsDiv.style.display === '') ? 'block' : 'none'; 
        });
        threadDiv.appendChild(headerDiv);
        threadDiv.appendChild(detailsDiv);
        resultsDiv.appendChild(threadDiv);
    });
  }

  function searchInThreads(threads, keyword, documentName = null, searchType = 'all', searchMode = 'default') {
    const searchResults = [];
    
    // é€šå¸¸ã®IDæ¤œç´¢
    const idSearchMatch = searchType !== 'title' ? keyword.match(/^id:\s*(.*)/i) : null;

    if (idSearchMatch) {
        const targetId = idSearchMatch[1].trim().replace(/\s/g, '');
        if (targetId) {
            threads.forEach(thread => {
                const matchedPosts = thread.posts.filter(p => p.userId && (targetId.length < 4 ? p.userId.startsWith(targetId) : p.userId.includes(targetId)));
                if (matchedPosts.length > 0) searchResults.push({ ...thread, matchedPosts, documentName });
            });
        }
    } else {
        // OR/ANDæ¤œç´¢ã®å‡¦ç†
        if (searchMode === 'and' || searchMode === 'or') {
            const keywords = keyword.split(/\s+/).filter(k => k.trim());
            if (keywords.length > 1) {
                threads.forEach(thread => {
                    let postsMatchingKeyword = [];
                    let titleMatches = false;

                    if (searchType === 'body' || searchType === 'all') {
                        postsMatchingKeyword = thread.posts.filter(post => {
                            const cleanContent = post.content.toLowerCase();
                            const authorLower = post.author.toLowerCase();
                            const userIdLower = post.userId.toLowerCase().replace(/\s/g, '');
                            
                            if (searchMode === 'and') {
                                // ANDæ¤œç´¢: å…¨ã¦ã®ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ãŒå«ã¾ã‚Œã¦ã„ã‚‹
                                return keywords.every(kw => {
                                    const kwLower = kw.toLowerCase();
                                    const kwForId = kwLower.replace(/\s/g, '');
                                    return cleanContent.includes(kwLower) || 
                                           authorLower.includes(kwLower) || 
                                           userIdLower.includes(kwForId);
                                });
                            } else {
                                // ORæ¤œç´¢: ã„ãšã‚Œã‹ã®ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ãŒå«ã¾ã‚Œã¦ã„ã‚‹
                                return keywords.some(kw => {
                                    const kwLower = kw.toLowerCase();
                                    const kwForId = kwLower.replace(/\s/g, '');
                                    return cleanContent.includes(kwLower) || 
                                           authorLower.includes(kwLower) || 
                                           userIdLower.includes(kwForId);
                                });
                            }
                        });
                    }
                    
                    if (searchType === 'title' || searchType === 'all') {
                        const titleLower = thread.title.toLowerCase();
                        if (searchMode === 'and') {
                            titleMatches = keywords.every(kw => titleLower.includes(kw.toLowerCase()));
                        } else {
                            titleMatches = keywords.some(kw => titleLower.includes(kw.toLowerCase()));
                        }
                    }

                    if (postsMatchingKeyword.length > 0 || titleMatches) {
                        let finalMatchedPosts = [...postsMatchingKeyword];
                        if (titleMatches && thread.posts.length > 0 && !finalMatchedPosts.some(p => p.postNumber === 1)) {
                            finalMatchedPosts.unshift(thread.posts[0]);
                        }
                        if (finalMatchedPosts.length > 0) {
                            searchResults.push({ ...thread, matchedPosts: finalMatchedPosts, documentName });
                        }
                    }
                });
                return searchResults;
            }
        }
        
        // é€šå¸¸æ¤œç´¢ï¼ˆãƒ‡ãƒ•ã‚©ãƒ«ãƒˆï¼‰
        const lowerKeyword = keyword.toLowerCase();
        const keywordForIdSearch = lowerKeyword.replace(/\s/g, '');
        threads.forEach(thread => {
            let postsMatchingKeyword = [];
            let titleMatches = false;

            if (searchType === 'body' || searchType === 'all') {
                postsMatchingKeyword = thread.posts.filter(p => 
                    (p.author && p.author.toLowerCase().includes(lowerKeyword)) ||
                    (p.userId && p.userId.toLowerCase().includes(keywordForIdSearch)) ||
                    (p.content && p.content.toLowerCase().includes(lowerKeyword))
                );
            }
            if (searchType === 'title' || searchType === 'all') {
                titleMatches = thread.title.toLowerCase().includes(lowerKeyword);
            }

            if (postsMatchingKeyword.length > 0 || titleMatches) {
                let finalMatchedPosts = [...postsMatchingKeyword];
                if (titleMatches && thread.posts.length > 0 && !finalMatchedPosts.some(p => p.postNumber === 1)) {
                    finalMatchedPosts.unshift(thread.posts[0]);
                }
                if (finalMatchedPosts.length > 0) {
                    searchResults.push({ ...thread, matchedPosts: finalMatchedPosts, documentName });
                }
            }
        });
    }
    return searchResults;
  }
  
  async function searchPosts() {
    const keyword = document.getElementById('searchInput').value.trim();
    if (!keyword) {
      clearSearch();
      return;
    }

    const fetchSuccess = await fetchRequiredDocuments();
    if (!fetchSuccess) return;

    if (allDocumentThreads.size === 0) {
      updateInfoPanel('<span style="color: #c0392b;">æ¤œç´¢å¯¾è±¡ã®ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆãŒã‚ã‚Šã¾ã›ã‚“ã€‚</span>');
      return;
    }

    document.getElementById('results').innerHTML = '<div class="loading">æ¤œç´¢ä¸­...</div>';
    
    setTimeout(() => {
      let searchResults = [];
      const searchType = document.querySelector('input[name="searchType"]:checked').value;
      const searchMode = document.querySelector('input[name="searchMode"]:checked').value;
      
      // æ¤œç´¢å®Ÿè¡Œ
      allDocumentThreads.forEach((threads, docId) => {
        searchResults.push(...searchInThreads(threads, keyword, docId, searchType, searchMode));
      });

      currentSearchResults = searchResults;
      const sortOrder = document.querySelector('input[name="sortOrder"]:checked').value;
      const sortedResults = sortSearchResults(searchResults, sortOrder);
      renderSearchResults(sortedResults, keyword);
      updateUrlParams(keyword, searchType);
    }, 100);
  }

  function applySorting() {
    if (currentSearchResults.length === 0) return;
    const keyword = document.getElementById('searchInput').value.trim();
    const sortOrder = document.querySelector('input[name="sortOrder"]:checked').value;
    const sortedResults = sortSearchResults(currentSearchResults, sortOrder);
    renderSearchResults(sortedResults, keyword);
  }
  
  function clearSearch() {
    document.getElementById('searchInput').value = '';
    document.getElementById('results').innerHTML = '<p>æ¤œç´¢ãƒœãƒƒã‚¯ã‚¹ã«ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã‚’å…¥åŠ›ã—ã¦æ¤œç´¢ã—ã¦ãã ã•ã„ã€‚</p>';
    document.getElementById('searchSummary').style.display = 'none';
    document.getElementById('sortOptions').style.display = 'none';
    currentSearchResults = [];
    updateInfoPanel();
    updateUrlParams('', 'all');
  }

  function resetFetchState() {
    allDocuments = [];
    allDocumentThreads.clear();
    fetchedDocumentIds.clear();
    currentSearchResults = [];
    document.getElementById('results').innerHTML = '';
    document.getElementById('searchSummary').style.display = 'none';
    document.getElementById('sortOptions').style.display = 'none';
    renderDocumentsList();
    const infoDiv = document.getElementById('info');
    infoDiv.innerHTML = `ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚’ã‚¯ãƒªã‚¢ã—ã¾ã—ãŸã€‚æ¬¡ã®æ¤œç´¢æ™‚ã«ãƒ‡ãƒ¼ã‚¿ã‚’å†å–å¾—ã—ã¾ã™ã€‚<br>æº–å‚™å®Œäº†ã€‚å…¨${totalDocumentCount}ä»¶ã®ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã‹ã‚‰æ¤œç´¢ã§ãã¾ã™ã€‚`;
  }

  function updateUrlParams(keyword, searchType = null, searchMode = null) {
    const url = new URL(window.location);
    
    // æ¤œç´¢ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã®è¨­å®š
    if (keyword) {
      url.searchParams.set('search', keyword);
    } else {
      url.searchParams.delete('search');
    }
    
    // æ¤œç´¢ç¯„å›²ã®è¨­å®š
    if (searchType && searchType !== 'all') {
      if (searchType === 'title') {
        url.searchParams.set('type', 'suretai');
      } else if (searchType === 'body') {
        url.searchParams.set('type', 'honbun');
      }
    } else {
      url.searchParams.set('type', 'subete');
    }
    
    // æ¤œç´¢ãƒ¢ãƒ¼ãƒ‰ã®è¨­å®š
    if (searchMode) {
      if (searchMode === 'and') {
        url.searchParams.set('mode', 'and');
      } else if (searchMode === 'or') {
        url.searchParams.set('mode', 'or');
      } else {
        url.searchParams.set('mode', 'tuuzyou');
      }
    } else {
      url.searchParams.set('mode', 'tuuzyou');
    }
    
    window.history.pushState({}, '', url);
  }

  function checkUrlParams() {
    const params = new URLSearchParams(window.location.search);
    const searchParam = params.get('search');
    const typeParam = params.get('type');
    const modeParam = params.get('mode');
    
    // æ¤œç´¢ç¯„å›²ã®è¨­å®š
    if (typeParam) {
      if (typeParam === 'suretai') {
        document.querySelector('input[name="searchType"][value="title"]').checked = true;
      } else if (typeParam === 'honbun') {
        document.querySelector('input[name="searchType"][value="body"]').checked = true;
      } else {
        document.querySelector('input[name="searchType"][value="all"]').checked = true;
      }
    }
    
    // æ¤œç´¢ãƒ¢ãƒ¼ãƒ‰ã®è¨­å®š
    if (modeParam) {
      if (modeParam === 'and') {
        document.querySelector('input[name="searchMode"][value="and"]').checked = true;
      } else if (modeParam === 'or') {
        document.querySelector('input[name="searchMode"][value="or"]').checked = true;
      } else {
        document.querySelector('input[name="searchMode"][value="default"]').checked = true;
      }
    }
    
    // æ¤œç´¢å®Ÿè¡Œ
    if (searchParam) {
      document.getElementById('searchInput').value = searchParam;
      searchPosts();
    }
  }

  function shareUrl() {
    const shareButton = document.getElementById('shareBtn');
    const originalText = shareButton.textContent;
    const keyword = document.getElementById('searchInput').value.trim();
    const searchType = document.querySelector('input[name="searchType"]:checked').value;
    
    const url = new URL(window.location);
    if (keyword) {
      url.searchParams.set('search', keyword);
      if (searchType === 'title') {
        url.searchParams.set('type', 'suretai');
      } else if (searchType === 'body') {
        url.searchParams.set('type', 'honbun');
      } else {
        url.searchParams.set('type', 'subete');
      }
    } else {
      url.searchParams.delete('search');
      url.searchParams.delete('type');
    }

    navigator.clipboard.writeText(url.toString()).then(() => {
      shareButton.textContent = 'ã‚³ãƒ”ãƒ¼å®Œäº†';
      setTimeout(() => { shareButton.textContent = originalText; }, 2000);
    }).catch(() => { 
      prompt('ä»¥ä¸‹ã®URLã‚’ã‚³ãƒ”ãƒ¼ã—ã¦ãã ã•ã„:', url.toString()); 
    });
  }
  
  // ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ã®è¨­å®š
  document.getElementById('searchBtn').addEventListener('click', searchPosts);
  document.getElementById('clearBtn').addEventListener('click', clearSearch);
  document.getElementById('docsBtn').addEventListener('click', toggleDocumentsList);
  document.getElementById('shareBtn').addEventListener('click', shareUrl);
  document.getElementById('helpBtn').addEventListener('click', toggleHelpPanel);
  
  document.getElementById('refreshBtn').addEventListener('click', () => {
    resetFetchState();
    if (document.getElementById('searchInput').value.trim()) {
      searchPosts();
    }
  });

  document.getElementById('fetchAllDocs').addEventListener('change', (e) => {
    document.getElementById('fetchCount').disabled = e.target.checked;
    resetFetchState();
    if (document.getElementById('searchInput').value.trim()) {
      searchPosts();
    }
  });
  
  document.getElementById('searchInput').addEventListener('keypress', (e) => {
    if (e.key === 'Enter') { e.preventDefault(); searchPosts(); }
  });
  
  document.querySelectorAll('input[name="sortOrder"]').forEach(radio => {
    radio.addEventListener('change', applySorting);
  });

  document.querySelectorAll('input[name="searchType"]').forEach(radio => {
    radio.addEventListener('change', () => {
      if (document.getElementById('searchInput').value.trim()) {
        searchPosts();
      }
    });
  });

  document.querySelectorAll('input[name="searchMode"]').forEach(radio => {
    radio.addEventListener('change', () => {
      if (document.getElementById('searchInput').value.trim()) {
        searchPosts();
      }
    });
  });

  window.addEventListener('popstate', checkUrlParams);
  
  // åˆæœŸåŒ–
  initializeSystem();
</script>
</body>
</html>
